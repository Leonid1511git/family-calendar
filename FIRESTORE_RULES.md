# Правила доступа Firestore

Чтобы события из бота отображались в календаре, приложение должно иметь **право на чтение** коллекции `events`. Ниже — как проверить и при необходимости обновить правила.

## 1. Где смотреть правила

1. Откройте [Firebase Console](https://console.firebase.google.com/) и выберите проект (например, `family-calendar-22abd`).
2. В меню слева: **Build** → **Firestore Database**.
3. Перейдите на вкладку **Rules** (Правила).

Там отображается текущий файл правил.

## 2. Что должно быть для календаря и бота

Для коллекции `events` достаточно разрешить **чтение и запись** любому авторизованному пользователю:

```
match /events/{eventId} {
  allow read: if request.auth != null;
  allow write: if request.auth != null;
}
```

В вашем проекте это уже задано в файле `firestore.rules` в корне репозитория. Если в консоли отображается то же самое — менять ничего не нужно.

## 3. Как задеплоить правила из проекта

Если вы меняли `firestore.rules` локально и хотите применить их в Firebase:

1. В терминале в корне проекта выполните:
   ```bash
   npx firebase-tools deploy --only firestore:rules
   ```
   (или `firebase deploy --only firestore:rules`, если установлен Firebase CLI.)

2. Введите проект при запросе или укажите его явно:
   ```bash
   npx firebase-tools deploy --only firestore:rules --project family-calendar-22abd
   ```

3. В консоли Firebase снова откройте **Firestore** → **Rules** и убедитесь, что правила совпадают с локальным файлом.

## 4. Как проверить, что чтение events разрешено

- В **Rules** должна быть секция для `events` с `allow read: if request.auth != null;`.
- Пользователь в приложении должен быть авторизован через Firebase Auth (например, через вход по Telegram и `signInWithCustomToken`). Тогда `request.auth != null` и чтение событий разрешено.

## 5. (По желанию) Ограничить доступ по группе

Можно ужесточить правила так, чтобы пользователь видел только события своей группы. Для этого нужно проверять членство в группе (например, по документу в `groups/{groupId}/members/{userId}`). Такой вариант требует отдельной настройки под вашу модель данных; текущие правила уже допускают чтение всех событий любым авторизованным пользователем, этого достаточно для отображения событий из бота в календаре.

---

**Итог:** если в консоли в разделе Firestore → Rules для `events` стоит `allow read: if request.auth != null;` и правила задеплоены (`firebase deploy --only firestore:rules`), то доступ на чтение коллекции `events` у клиента уже есть. Если события из бота по-прежнему не появляются, причина, как правило, в другом (например, в том, что приложение подписывается на другую группу — это исправлено через использование `user?.currentGroupId` при подписке).
