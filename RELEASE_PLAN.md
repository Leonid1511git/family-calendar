# План релиза: тестовые сборки .apk и .ipa (без публикации в сторы)

Этот документ — пошаговая инструкция для подготовки приложения Family Calendar к тестированию на реальных пользователях. Сборки распространяются **файлами** (по ссылке), без публикации в Google Play и App Store.

**Что получится в итоге:**
- **Android:** файл `.apk` — тестировщик скачивает по ссылке и устанавливает на телефон.
- **iOS:** файл `.ipa` — тестировщик устанавливает через ссылку (или TestFlight, если настроите позже).

---

## Часть 0. Что уже должно быть сделано (проверьте)

Перед сборкой убедитесь, что:

1. **Firebase**  
   - Проект создан, включены Authentication, Firestore, Hosting, Cloud Functions.  
   - Документация в проекте: `FIREBASE_AUTH_CONFIG.md`, `SETUP_INSTRUCTIONS.md`.

2. **Telegram-бот**  
   - Бот создан через [@BotFather](https://t.me/BotFather).  
   - В BotFather для бота задан **домен** для Telegram Login (см. ниже, шаг 1).

3. **Хостинг для входа через Telegram**  
   - Развёрнут Firebase Hosting с страницами входа (например, `telegram-login.html`, `telegram-callback.html`).  
   - URL вида: `https://family-calendar-22abd.web.app` (или ваш домен).  
   - Этот же URL указан в конфиге приложения (`AUTH_PROXY_URL`) и в BotFather как домен для виджета.

4. **Cloud Functions**  
   - Развёрнуты функции (в т.ч. `getTelegramCustomToken`, `telegramWebhook`, `onTelegramNotificationCreated`).  
   - Команда: `npx firebase-tools deploy --only functions` (из папки проекта).

Если чего-то из этого нет — сначала настройте по документации в репозитории, иначе вход через Telegram в собранном приложении не заработает.

---

## Часть 1. Настройка домена для входа через Telegram (один раз)

**Зачем:** виджет «Войти через Telegram» открывает страницу на вашем HTTPS-домене. Telegram проверяет, что домен разрешён для бота.

**Шаги:**

1. Откройте Telegram, найдите [@BotFather](https://t.me/BotFather).
2. Отправьте команду: `/mybots` → выберите вашего бота (например, FamilyCalendarApp_bot).
3. Выберите **Bot Settings** → **Domain** (или «Добавить домен»).
4. Укажите домен **без** `https://` и без пути, например:  
   `family-calendar-22abd.web.app`  
   (если используете свой домен — укажите его).
5. Сохраните. Домен должен совпадать с тем, на котором лежат `telegram-login.html` и страница возврата после входа.

**Проверка:** откройте в браузере `https://ваш-домен/telegram-login.html` — страница должна открываться (виджет может показывать ошибку до первого входа — это нормально).

---

## Часть 2. Учётная запись Expo и EAS

**Зачем:** сборки .apk и .ipa делаются в облаке Expo (EAS Build). Нужна бесплатная учётная запись.

**Шаги:**

1. Зайдите на [https://expo.dev](https://expo.dev) и зарегистрируйтесь (или войдите).
2. Глобально устанавливать EAS CLI не обязательно. Используйте **npx** (скачает при первом запуске):  
   ```bash
   npx eas-cli login
   ```
   Если хотите установить глобально и получаете ошибку прав доступа — см. конец этого раздела.
3. В папке проекта выполните:  
   ```bash
   npx eas-cli login
   ```
   Введите логин и пароль Expo.
4. Привяжите проект к аккаунту Expo (если ещё не привязан):  
   ```bash
   npx eas-cli build:configure
   ```
   (Команда `eas` без `npx` работает только после глобальной установки; используйте `npx eas-cli`.)
   Следуйте подсказкам; можно оставить значения по умолчанию.

**Если при глобальной установке была ошибка «EACCES: permission denied»:** не ставьте глобально — везде используйте `npx eas-cli` вместо `eas`. Либо установите с правами администратора: `sudo npm install -g eas-cli` (введите пароль при запросе).

После этого проект готов к запуску облачных сборок.

---

## Часть 2.1. Секрет для входа через Telegram (обязательно для тестовых сборок)

Чтобы в собранном приложении работал вход через Telegram, в облачную сборку нужно подставить токен бота через **EAS Secret** (в коде токен не хранится).

1. Откройте [expo.dev](https://expo.dev) → ваш проект → **Secrets** (или Project settings → Secrets).
2. Нажмите **Create secret**.
3. Имя: `EXPO_PUBLIC_TELEGRAM_BOT_TOKEN`, значение: ваш токен бота (из @BotFather, например `123456:ABC-DEF...`).
4. Сохраните. При следующей сборке EAS подставит это значение в приложение.

Опционально можно задать:
- `EXPO_PUBLIC_TELEGRAM_BOT_NAME` — имя бота (по умолчанию `FamilyCalendarApp_bot`).
- `EXPO_PUBLIC_TELEGRAM_AUTH_PROXY_URL` — URL страницы входа (по умолчанию `https://family-calendar-22abd.web.app`).

**Локальная разработка:** создайте в корне проекта файл `.env` (он в .gitignore) и добавьте строку:
`EXPO_PUBLIC_TELEGRAM_BOT_TOKEN=ваш_токен`

---

## Часть 3. Сборка Android (.apk)

**Зачем:** получить один файл `.apk`, который тестировщики скачивают по ссылке и устанавливают на Android-устройство.

**Шаги:**

1. Откройте терминал, перейдите в папку проекта:  
   ```bash
   cd путь/к/family-calendar-v2
   ```

2. Запустите сборку для Android (APK для внутреннего распространения):  
   ```bash
   npm run build:apk
   ```
   Или напрямую:  
   ```bash
   eas build --profile preview --platform android
   ```

3. Если EAS спросит про ключ подписи (keystore) — выберите **Generate new keystore** (создать новый). Его потом можно использовать для обновлений.

4. Дождитесь окончания сборки (5–15 минут). Статус смотрите в терминале или в [expo.dev](https://expo.dev) → ваш проект → Builds.

5. Когда сборка станет **Finished**:
   - В [expo.dev](https://expo.dev) → Builds → откройте эту сборку.
   - Там будет **ссылка на скачивание** и **QR-код**.
   - Скачайте `.apk` по ссылке или отсканируйте QR-код телефоном и скачайте файл.

6. Раздайте тестировщикам:
   - Вариант А: отправьте прямую ссылку на скачивание (из экспо-дашборда).
   - Вариант Б: скачайте `.apk` сами и передайте файл (мессенджер, облако, и т.д.).

**Установка на Android:** включите «Установка из неизвестных источников» (или «Разрешить установку из этого источника») для браузера или файлового менеджера, откройте ссылку/файл и установите приложение.

Подробнее: [Build APKs for Android](https://docs.expo.dev/build-reference/apk/), [Internal distribution](https://docs.expo.dev/build/internal-distribution/).

---

## Часть 4. Сборка iOS (.ipa)

**Зачем:** получить сборку для установки на реальные iPhone/iPad без публикации в App Store (внутреннее тестирование).

**Особенность:** для подписи iOS-приложения нужна **Apple Developer Program** (платная, около $99/год). Без неё собрать .ipa для реального устройства нельзя.

**Шаги:**

1. Убедитесь, что вы в программе разработчика Apple: [developer.apple.com](https://developer.apple.com).

2. В папке проекта выполните:  
   ```bash
   npm run build:ipa
   ```
   Или напрямую:  
   ```bash
   eas build --profile preview-device --platform ios
   ```

3. При первом запуске EAS может предложить создать Apple App Store Connect API Key или войти в Apple ID. Следуйте [инструкции EAS](https://docs.expo.dev/build-reference/ios-credentials/).

4. Дождитесь окончания сборки.

5. Готовый `.ipa`:
   - Скачивается из [expo.dev](https://expo.dev) → Builds → выбранная сборка.
   - Ссылку можно отдать тестировщикам с Apple ID, добавленным в группу тестировщиков (Ad Hoc), или использовать [Internal Distribution](https://docs.expo.dev/build/internal-distribution/) / TestFlight.

**Важно:** для установки .ipa на устройство тестировщика его UDID обычно должен быть зарегистрирован в профиле подготовки (Ad Hoc) или тестировщик должен быть в TestFlight. Подробности: [Share builds with testers](https://docs.expo.dev/build/internal-distribution/#share-builds-with-testers).

Если **нет Apple Developer Program**, iOS-сборку для реальных устройств сделать нельзя; тестировать можно только в симуляторе на Mac (`eas build --profile preview --platform ios` — симулятор).

---

## Часть 5. Перед раздачей сборок: чек-лист

- [ ] Firebase Hosting развёрнут, страницы входа открываются по HTTPS.
- [ ] В BotFather задан домен для бота (тот же, что у Hosting).
- [ ] Cloud Functions задеплоены (`npx firebase-tools deploy --only functions`).
- [ ] В приложении в настройках/конфиге указан правильный `AUTH_PROXY_URL` (ваш HTTPS-домен).
- [ ] Собрана нужная версия приложения (например, после правок для боевого режима — см. ниже).
- [ ] Тестировщикам написано: **входить только через кнопку «Войти через Telegram»** (тестовый вход в релизной сборке отключён).

---

## Часть 6. Что изменено в коде для боевого использования

Перед сборкой для тестирования уже внесены такие изменения:

1. **Отладочные запросы**  
   Все вызовы на `http://127.0.0.1:7242/...` выполняются только в режиме разработки (`__DEV__`). В собранном .apk/.ipa они не выполняются.

2. **Кнопка «Тестовый вход (Dev)»**  
   Показывается только в режиме разработки. В релизной сборке тестировщики видят только «Войти через Telegram».

3. **Блок «Диагностика входа»**  
   Показывается только в режиме разработки. В релизной сборке его нет.

4. **Конфиг Telegram**  
   В `src/config/telegram.ts` (или аналоге) задан `AUTH_PROXY_URL`: должен указывать на ваш боевой HTTPS-домен (например, `https://family-calendar-22abd.web.app`). Для другого домена нужно поменять и пересобрать приложение.

5. **Профиль сборки iOS**  
   В `eas.json` у профиля `preview-device` для iOS отключён симулятор (`simulator: false`), чтобы собиралась сборка для реальных устройств (.ipa).

Дополнительно для «боевого» использования стоит:
- Хранить токен бота и секреты в Firebase Secrets / переменных окружения, а не в коде (см. документацию по Cloud Functions).
- При необходимости включить правила безопасности Firestore и проверить лимиты.

---

## Краткая шпаргалка команд

| Действие | Команда |
|----------|--------|
| Войти в Expo | `npx eas-cli login` |
| Сборка Android (.apk) | `npm run build:apk` или `npx eas-cli build --profile preview --platform android` |
| Сборка iOS (.ipa) | `npm run build:ipa` или `npx eas-cli build --profile preview-device --platform ios` |
| Деплой Firebase (Hosting + Functions) | `npx firebase-tools deploy` или `--only hosting` / `--only functions` |

---

## Полезные ссылки

- [Expo — Build](https://docs.expo.dev/build/introduction/)
- [EAS Build: APK для Android](https://docs.expo.dev/build-reference/apk/)
- [EAS Build: внутреннее распространение](https://docs.expo.dev/build/internal-distribution/)
- [Настройка iOS-учётных данных](https://docs.expo.dev/build-reference/ios-credentials/)
- [Firebase Hosting](https://firebase.google.com/docs/hosting)
- [Telegram Login Widget](https://core.telegram.org/widgets/login)

---

**Примечание про .ics:**  
Формат .ics — это календарные файлы (импорт/экспорт событий), а не установочный пакет приложения. Если нужен экспорт календаря в .ics для тестирования, это отдельная функция в приложении; текущий план описывает только сборки приложения (.apk и .ipa) для установки на устройства.
