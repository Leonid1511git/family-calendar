# Задержка ответа бота (холодный старт)

Если ответ бота приходит через несколько минут, скорее всего срабатывает **холодный старт** Cloud Function: экземпляр не был запущен, Google поднимает его по первому запросу (10–60+ секунд, иногда больше).

## Как проверить по логам

После деплоя с новым кодом в логах будет строка:

- `[timing] user doc get took Xms` — время именно чтения документа пользователя.

Если **X маленький** (десятки–сотни ms), а до «user found» всё равно прошло много минут — задержка была **до** входа в функцию (очередь/холодный старт). Если **X большой** (десятки секунд) — медленное первое обращение к Firestore в холодном экземпляре.

## Как уменьшить задержку

### 1. Минимальное число экземпляров (платно)

В [Firebase Console](https://console.firebase.google.com/) → Functions → настройки функции `telegramWebhook` (или через `gcloud`) задайте **Minimum instances: 1**. Тогда один экземпляр всегда «тёплый», первый запрос обрабатывается без холодного старта.

### 2. Периодический «прогрев» (рекомендуется)

Функция поддерживает запрос с **`warmup: true`**: при таком теле делается одно обращение к Firestore (чтобы «прогреть» клиент) и сразу возвращается 200. Вызывайте этот URL по расписанию раз в 5–10 минут (Cloud Scheduler, cron или любой мониторинг).

**URL:** тот же, что и webhook (например  
`https://us-central1-family-calendar-22abd.cloudfunctions.net/telegramWebhook`).

**Метод:** POST  
**Тело:** `{"warmup":true}`  
**Content-Type:** `application/json`

Пример (curl):

```bash
curl -X POST "https://us-central1-YOUR_PROJECT.cloudfunctions.net/telegramWebhook" \
  -H "Content-Type: application/json" \
  -d '{"warmup": true}'
```

В логах будет строка `[warmup] Firestore touched in Xms`. После такого прогрева следующий реальный запрос от Telegram обрабатывается быстрее (экземпляр и Firestore уже «тёплые»).

### 3. Уже сделано в коде

- Поиск пользователя заменён на **прямое чтение** документа `users/tg_{telegramId}` вместо запроса по полю `telegramId` — после прогрева этот шаг выполняется за миллисекунды.
